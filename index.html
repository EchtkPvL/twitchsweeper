<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TwitchSweeper</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="98.css">
    <script src="main.js"></script>
    <script>
        // https://github.com/obsproject/obs-browser/blob/master/README.md
        window.obsstudio.getStatus(function (status) {
            console.log(status)
        })
    </script>
</head>

<body>
    <div class="window" style="width: 237px">
        <div class="title-bar">
            <div class="title-bar-text">TWITCHSWEEPER</div>
            <div class="title-bar-controls title-bar-controls-right">
                <button aria-label="Minimize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            <table id="gameheader">
                <tr>
                    <th id="score">909</th>
                    <th id="action"><button>:)</button></th>
                    <th id="time">909</th>
                </tr>
            </table>
            <table id="game">
                <tr>
                    <td>loading</td>
                </tr>
            </table>
        </div>
        <div class="status-bar">
            <p class="status-bar-field">x-y in chat to play</p>
            <p class="status-bar-field" id="status">Slide 1</p>
            <p class="status-bar-field">wip</p>
        </div>
    </div>
    <script>
        var game = new TwitchSweeper(0, 'game');
        // START Just for dev
        //let brotkrumen = setInterval(brotkrumenenenen, 400);
        function brotkrumenenenen() {
            if (game.turn(Math.floor(Math.random() * 8), Math.floor(Math.random() * 8)) === false) brotkrumen = false;
        }
        // END Just for dev

        setInterval(gameMeta, 100);
        function gameMeta() {
            var time = game.getTime();
            if (time > 999) window.location.reload();
            var el = document.getElementById('time');
            el.innerHTML = time;

            var mines = game.getMines();
            var el = document.getElementById('score');
            el.innerHTML = mines;

            var state = game.getGameOver();
            if (state !== false) state = '"!new" to restart';
            var el = document.getElementById('status');
            el.innerHTML = state;
        }

        const ws = new WebSocket("ws://irc-ws.chat.twitch.tv:80");
        ws.onopen = function (openEvent) {
            ws.send("CAP REQ :twitch.tv/membership twitch.tv/tags twitch.tv/commands");
            ws.send("PASS oauth:abcdefghijklmnopqrstuvwxyz0123");
            ws.send("NICK justinfan1337");
            ws.send("JOIN #echtkpvlbot");
        };
        ws.onmessage = function (messageEvent) {
            var parsed = parseMessage(messageEvent.data);
            var msg = parsed.message;
            console.log(parsed);
            if (parsed !== null) {
                if (parsed.command === "PRIVMSG") {
                    console.log("MSG: " + msg + " from " + parsed.username);

                    // magic
                    if (/^\d+-\d+$/.test(msg)) {
                        let x = msg.split('-')[0] - 1;
                        let y = msg.split('-')[1] - 1;
                        game.turn(x, y);
                    }

                    // magic
                    if (/^!new$/.test(msg)) {
                        game.setup();
                    }
                } else if (parsed.command === "PING") {
                    ws.send("PONG :" + msg);
                }
            }
        };
        ws.onclose = function (closeEvent) {
            console.log("WebSocket wurde geschlossen");
        };

        // Credits to: https://stackoverflow.com/questions/50383115
        function parseMessage(rawMessage) {
            var parsedMessage = {
                message: null,
                tags: null,
                command: null,
                original: rawMessage,
                channel: null,
                username: null
            };

            if (rawMessage[0] === '@') {
                var tagIndex = rawMessage.indexOf(' '),
                    userIndex = rawMessage.indexOf(' ', tagIndex + 1),
                    commandIndex = rawMessage.indexOf(' ', userIndex + 1),
                    channelIndex = rawMessage.indexOf(' ', commandIndex + 1),
                    messageIndex = rawMessage.indexOf(':', channelIndex + 1);

                parsedMessage.tags = rawMessage.slice(0, tagIndex);
                parsedMessage.username = rawMessage.slice(tagIndex + 2, rawMessage.indexOf('!'));
                parsedMessage.command = rawMessage.slice(userIndex + 1, commandIndex);
                parsedMessage.channel = rawMessage.slice(commandIndex + 1, channelIndex);
                parsedMessage.message = rawMessage.slice(messageIndex + 1).trim();
            } else if (rawMessage.startsWith("PING")) {
                parsedMessage.command = "PING";
                parsedMessage.message = rawMessage.split(":")[1];
            }

            return parsedMessage;
        }
    </script>
</body>

</html>